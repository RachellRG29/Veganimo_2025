<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verificaci√≥n de Correo</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Iconos -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Gloock&display=swap" rel="stylesheet" />

  <!-- CSS personalizado -->
  <link rel="stylesheet" href="/login/recuperar_correo/verificacion.css" />
  <link rel="website icon" href="../Images/Icono_veganimo.svg" />
  
</head>
<body class="custom-bg d-flex min-vh-100 px-3">

  <!-- Contenedor general -->
  <div class="container position-relative d-flex align-items-center">

    <!-- Card del formulario -->
    <div class="card shadow-lg rounded-4 overflow-hidden custom-form-card p-4">
      <div class="text-center mb-4">
        <div class="logo-container">
          <div class="img-fluid logo" alt="isotipo">
            <?xml version="1.0" encoding="UTF-8"?>
              <svg id="Capa_2" data-name="Capa 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 168.68 199.52">
              <g id="Veganimo">
                  <g>
                  <path class="cls-1" d="M86.29,80.26c-.7-.61-1.28-1.32-1.77-2.05,3.86,9,7.35,17.37,8.89,21.71l8.39-17.96c-5.41,2.01-11.23,2.03-15.51-1.7Z"/>
                  <path class="cls-1" d="M136.3,0H32.38C14.5,0,0,14.49,0,32.38V167.13c0,17.89,14.5,32.39,32.38,32.39h103.92c17.88,0,32.38-14.5,32.38-32.39V32.38c0-17.89-14.5-32.38-32.38-32.38Zm6.77,33.9c-6.17-.63-10.49,1.22-14.22,4.34-3.91,3.28-5.37,7.22-6.64,10.77-2.46,6.91-3.56,14.68-6.72,21.31-1.54,3.22-4.54,6.39-8.17,8.8l-20.9,44.76h15.89c-1.85-10.13,1.45-20.96,9.71-28.35,7.33-6.55,16.95-8.94,25.92-7.28,1.27,1.45-6.95,10.87-10.25,13.82,3.3-2.95,13.58-10.07,14.89-8.63,.63,9.1-2.8,18.38-10.14,24.94-2.66,2.39-5.63,4.21-8.76,5.5h14.16c3.04,0,5.45,2.6,5.17,5.62-1.57,16.65-10.06,31.28-22.55,41.01-4.3,3.34-9.6,5.13-15.04,5.13-.31,0-.55,.25-.55,.55v2.33c0,1.71-1.39,3.1-3.1,3.1h-34.82c-1.71,0-3.1-1.39-3.1-3.1v-2.33c0-.31-.25-.55-.55-.55h-.25c-5.44,0-10.75-1.79-15.05-5.13-12.49-9.73-20.98-24.36-22.54-41.01-.29-3.02,2.13-5.62,5.16-5.62h23.36c-2.31-.91-4.47-2.3-6.33-4.18-4.77-4.83-6.3-11.64-4.62-17.74,6.13-1.59,12.9,.03,17.67,4.86,4.6,4.66,6.18,11.14,4.8,17.06h14.23L42.97,44.17c-4.22-9.35-8.99-14.02-14.29-14.02h-.45v-1.29h49.92v1.29h-.61c-4.52,0-7.51,1.17-8.98,3.53-1.48,2.36-1.23,5.64,.74,9.84,0,0,6.93,15.5,13.49,30.68,1.45,.76,5.37,.96,6.1,.91,1.77-.12,3.93-.58,5.38-1.45,3.79-2.3,6.64-7.11,7.97-10.94,1.54-4.33,2.59-9.32,4.44-13.83,2.15-5.32,5.27-10.6,10.29-14.42,5.17-4.09,13.11-6.26,20.38-4.16,2.31,.68,4.43,1.79,5.92,3.27l-.2,.32Z"/>
                  </g>
              </g>
              </svg>
          </div>
        </div>
      </div>

      <h2 class="form-title text-center mb-2">Verificar Correo</h2>
      <div class="separator mx-auto mb-4"></div>

      <form>
        <label class="codigo-label">Ingrese el c√≥digo</label>
        <!-- Casillas de verificaci√≥n -->
        <div class="inp mb-4">
          <input maxlength="1" class="input" type="text" placeholder="x" />
          <input maxlength="1" class="input" type="text" placeholder="x" /> 
          <input maxlength="1" class="input" type="text" placeholder="x" /> 
          <input maxlength="1" class="input" type="text" placeholder="x" /> 
        </div>
        
        <div class="text-center">
          <button type="submit">Verificar</button>
        </div>
      </form>

      <div class="text-center mt-3">
        <a href="#" class="text-muted small d-block text-decoration-none">Reenviar c√≥digo</a>
      </div>
    </div>

    <!-- Imagen izquierda -->
    <img src="https://images.pexels.com/photos/30208902/pexels-photo-30208902/free-photo-of-fotografia-de-comida.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" 
         alt="Imagen" 
         class="img-fluid login-image d-none d-md-block" />
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- script para que n√∫meros de verificaci√≥n avancen autom√°ticamente -->
  <script>
  const inputs = document.querySelectorAll('.inp .input');

  inputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      let value = input.value;

      // Eliminar cualquier car√°cter que no sea n√∫mero
      value = value.replace(/\D/g, '');
      input.value = value;

      // Si se ingres√≥ un n√∫mero v√°lido, avanzar al siguiente input
      if (value && index < inputs.length - 1) {
        inputs[index + 1].focus();
      }
    });

    input.addEventListener('keydown', (e) => {
      // Retroceder si est√° vac√≠o y presiona Backspace
      if (e.key === "Backspace" && input.value === '' && index > 0) {
        inputs[index - 1].focus();
      }
    });

    input.addEventListener('paste', (e) => {
      e.preventDefault(); // Bloquear pegar
    });
  });
</script>


  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Configuraci√≥n global de SweetAlert
  const Toast = Swal.mixin({
    toast: true,
    position: 'bottom-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');
    const inputs = document.querySelectorAll('.input');
    const resendLink = document.querySelector('a[href="#"]');

    let cooldown = false;
    let intentos = 0;
    const MAX_INTENTOS = 7;

     document.querySelectorAll('.inp .input').forEach((input) => {
    input.addEventListener('input', (e) => {
      // Eliminar cualquier car√°cter que no sea n√∫mero
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    input.addEventListener('paste', (e) => {
      // Bloquear pegado directo
      e.preventDefault();
    });
  });

    // Funci√≥n para iniciar el temporizador de 60 segundos
    function startCooldown() {
      cooldown = true;
      resendLink.classList.add('disabled');
      resendLink.style.pointerEvents = 'none';
      resendLink.style.opacity = '0.5';

      let seconds = 60;
      resendLink.textContent = `Reenviar c√≥digo (${seconds}s)`;

      const interval = setInterval(() => {
        seconds--;
        resendLink.textContent = `Reenviar c√≥digo (${seconds}s)`;

        if (seconds <= 0) {
          clearInterval(interval);
          if (intentos < MAX_INTENTOS) {
            cooldown = false;
            resendLink.classList.remove('disabled');
            resendLink.style.pointerEvents = '';
            resendLink.style.opacity = '1';
            resendLink.textContent = 'Reenviar c√≥digo';
          }
        }
      }, 1000);
    }


        let intentosFallidos = 0;
    const MAX_INTENTOS_CODIGO = 7;

    // Env√≠o del formulario para verificar c√≥digo
      form.addEventListener('submit', function (e) {
  e.preventDefault();

  // ‚úÖ Validaci√≥n de campos vac√≠os con Toast
  const vacios = Array.from(inputs).some(input => input.value.trim() === '');
  if (vacios) {
    Toast.fire({
      icon: 'warning',
      title: 'Completa todos los d√≠gitos del c√≥digo.'
    });
    return; // üî¥ Detiene el flujo si hay campos vac√≠os
  }

  const now = Date.now();
  const bloqueadoHasta = localStorage.getItem('bloqueadoHasta');

  if (bloqueadoHasta && now < parseInt(bloqueadoHasta)) {
    const restante = Math.ceil((parseInt(bloqueadoHasta) - now) / 60000);
    Swal.fire({
      icon: 'error',
      title: 'Bloqueado',
      text: `Has excedido el n√∫mero de intentos. Intenta de nuevo en ${restante} minuto(s).`,
    });
    return;
  }

  const codigo = Array.from(inputs).map(input => input.value).join('');

  fetch('/login/recuperar_correo/verificar_codigo.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `verification_code=${codigo}`
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        localStorage.removeItem('bloqueadoHasta');
        intentosFallidos = 0;
        Toast.fire({
          icon: data.icon || 'success',
          title: data.message
        }).then(() => {
          if (data.redirect) {
            window.location.href = data.redirect;
          }
        });
      } else {
        intentosFallidos++;

        const intentosRestantes = MAX_INTENTOS_CODIGO - intentosFallidos;

        if (intentosRestantes === 3) {
          Swal.fire({
            icon: 'warning',
            title: 'Advertencia',
            text: '¬°Solo te quedan 3 intentos!',
          });
        } else if (intentosRestantes === 2) {
          Swal.fire({
            icon: 'warning',
            title: 'Advertencia',
            text: '¬°Solo te quedan 2 intentos!',
          });
        } else if (intentosRestantes === 1) {
          Swal.fire({
            icon: 'warning',
            title: '√öltimo intento',
            text: '¬°Este es tu √∫ltimo intento!',
          });
        } else if (intentosFallidos >= MAX_INTENTOS_CODIGO) {
          const diezMinutos = 10 * 60 * 1000;
          const desbloqueo = Date.now() + diezMinutos;
          localStorage.setItem('bloqueadoHasta', desbloqueo.toString());

          Swal.fire({
            icon: 'error',
            title: 'Demasiados intentos',
            text: 'Has sido bloqueado por 10 minutos.',
          });
          return;
        } else {
          Toast.fire({
            icon: data.icon || 'error',
            title: data.message
          });
        }
      }
    })
    .catch(() => {
      Toast.fire({
        icon: 'error',
        title: 'Error de conexi√≥n con el servidor'
      });
    });
});


    // Reenviar c√≥digo con l√≠mite de intentos
    resendLink.addEventListener('click', function (e) {
      e.preventDefault();
      if (cooldown || intentos >= MAX_INTENTOS) return;

      intentos++;

      if (intentos === MAX_INTENTOS) {
        Toast.fire({
          icon: 'warning',
          title: 'Este es tu √∫ltimo intento para reenviar el c√≥digo.'
        });
      }

        // Mostrar alerta de carga
    Swal.fire({
      title: 'Reenviando c√≥digo...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });


      fetch('/login/recuperar_correo/reenviar_codigo.php')
        .then(response => response.json())
        .then(data => {
          Swal.close(); // Cerrar la alerta de carga

          if (data.success) {
            Toast.fire({
              icon: 'success',
              title: 'Nuevo c√≥digo enviado a tu correo'
            });
            startCooldown();


            // Si ya alcanz√≥ el m√°ximo, desactivar definitivamente el enlace
            if (intentos >= MAX_INTENTOS) {
              resendLink.classList.add('disabled');
              resendLink.style.pointerEvents = 'none';
              resendLink.style.opacity = '0.5';
              resendLink.textContent = 'L√≠mite alcanzado';
            }

          } else {
            Toast.fire({
              icon: 'error',
              title: data.message || 'Error al reenviar c√≥digo'
            });
          }
        })
        .catch(() => {
          Toast.fire({
            icon: 'error',
            title: 'Error al contactar con el servidor'
          });
        });
    });
  });
</script>


</body>
</html>
