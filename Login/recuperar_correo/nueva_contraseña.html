<!-- /Login/recuperar_correo/nueva_contrase√±a.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Restablecer contrase√±a</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="/Login/login.css" />
  <link rel="stylesheet" href="/Login/recuperar_correo/nueva_contrase√±a.css" />
 
</head>
<body class="custom-bg d-flex min-vh-100 px-3">
  <div class="container d-flex align-items-center">
    <div class="card shadow-lg rounded-4 custom-form-card p-4 w-100">
      <h2 class="form-title text-center mb-4">Nueva contrase√±a</h2>

      <form id="form-nueva-contra">
        <!-- Contrase√±a -->
        <div class="mb-3">
          <label for="password" class="form-label">Contrase√±a nueva:</label>
          <div class="position-relative">
            <input type="password" id="password" class="form-control" placeholder="Ingrese su contrase√±a" required />
            <span class="password-toggle-inside" onclick="toggleVisibility('password', this)">
              <i class="fas fa-eye"></i>
            </span>
          </div>
        </div>
        <div id="password-message" class="form-text mt-1"></div>

        <ul id="password-requirements" class="form-text mt-2">
  <li id="req-length" class="text-danger">Al menos 6 caracteres</li>
  <li id="req-uppercase" class="text-danger">Al menos una may√∫scula</li>
  <li id="req-number" class="text-danger">Al menos un n√∫mero</li>
  <li id="req-symbol" class="text-danger">Al menos un s√≠mbolo</li>
</ul>


        <!-- Confirmar -->
        <div class="mb-4">
          <label for="confirm" class="form-label">Confirmar contrase√±a:</label>
          <div class="position-relative">
            <input type="password" id="confirm" class="form-control" placeholder="Confirme su contrase√±a" required />
            <span class="password-toggle-inside" onclick="toggleVisibility('confirm', this)">
              <i class="fas fa-eye"></i>
            </span>
          </div>
        </div>
        <div id="confirm-message" class="form-text mt-1"></div>


        <div id="msg" class="text-center mb-3"></div>
        <div class="text-center">
          <button type="submit" class="btn btn-primary">Actualizar contrase√±a</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirm');
  const form = document.getElementById('form-nueva-contra');

  const validationState = {
    password: false,
    confirm: false
  };

  const reqLength = document.getElementById('req-length');
  const reqUppercase = document.getElementById('req-uppercase');
  const reqNumber = document.getElementById('req-number');
  const reqSymbol = document.getElementById('req-symbol');

  function toggleVisibility(inputId, iconElement) {
    const input = document.getElementById(inputId);
    const icon = iconElement.querySelector('i');
    input.type = input.type === 'password' ? 'text' : 'password';
    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
  }

  function updateRequirement(element, isValid) {
    element.classList.toggle('text-success', isValid);
    element.classList.toggle('text-danger', !isValid);
  }

  function showFieldError(element, message) {
    element.classList.add('is-invalid');
    element.classList.remove('is-valid');
    const messageElement = document.getElementById(`${element.id}-message`);
    if (messageElement) {
      messageElement.textContent = message;
      messageElement.classList.add('text-danger');
      messageElement.classList.remove('text-success');
    }
  }

  function showFieldSuccess(element) {
    element.classList.add('is-valid');
    element.classList.remove('is-invalid');
    const messageElement = document.getElementById(`${element.id}-message`);
    if (messageElement) {
      messageElement.textContent = 'Campo v√°lido ‚úÖ';
      messageElement.classList.add('text-success');
      messageElement.classList.remove('text-danger');
    }
  }

  function showFormError(message) {
    Swal.fire({
      toast: true,
      position: 'bottom-end',
      icon: 'error',
      title: message,
      showConfirmButton: false,
      timer: 5000,
      timerProgressBar: true
    });
  }

  function validatePassword() {
    const value = passwordInput.value.trim();

    const hasLength = value.length >= 6;
    const hasUpper = /[A-Z]/.test(value);
    const hasNumber = /\d/.test(value);
    const hasSymbol = /[!@#$%^&*()\-_=+[\]{};:'",.<>/?\\|`~]/.test(value);

    updateRequirement(reqLength, hasLength);
    updateRequirement(reqUppercase, hasUpper);
    updateRequirement(reqNumber, hasNumber);
    updateRequirement(reqSymbol, hasSymbol);

    if (hasLength && hasUpper && hasNumber && hasSymbol) {
      showFieldSuccess(passwordInput);
      validationState.password = true;
    } else {
      showFieldError(passwordInput, 'Debe cumplir todos los requisitos');
      validationState.password = false;
    }

    validateConfirmPassword(); // validar tambi√©n confirmaci√≥n
  }

  function validateConfirmPassword() {
  const password = passwordInput.value.trim();
  const confirm = confirmPasswordInput.value.trim();
  const messageElement = document.getElementById('confirm-message');

  // Solo mostrar mensajes si el usuario ya escribi√≥ algo en el campo
  if (confirm.length === 0) {
    confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
    if (messageElement) {
      messageElement.textContent = '';
      messageElement.classList.remove('text-success', 'text-danger');
    }
    validationState.confirm = false;
    return;
  }

  // Mientras escribe, pero a√∫n no coincide
  if (confirm !== password) {
    confirmPasswordInput.classList.add('is-invalid');
    confirmPasswordInput.classList.remove('is-valid');
    if (messageElement) {
      messageElement.textContent = 'üîÑ Comparando con la contrase√±a...';
      messageElement.classList.remove('text-success');
      messageElement.classList.add('text-danger');
    }
    validationState.confirm = false;
  } else {
    confirmPasswordInput.classList.add('is-valid');
    confirmPasswordInput.classList.remove('is-invalid');
    if (messageElement) {
      messageElement.textContent = '‚úÖ Las contrase√±as coinciden';
      messageElement.classList.add('text-success');
      messageElement.classList.remove('text-danger');
    }
    validationState.confirm = true;
  }
}

function validateAllFields() {
  validatePassword();
  validateConfirmPassword();
  return Object.values(validationState).every(valid => valid);
}


  document.addEventListener('DOMContentLoaded', () => {
    passwordInput.addEventListener('input', validatePassword);
    confirmPasswordInput.addEventListener('input', validateConfirmPassword);

    // Bloquear espacios
    [passwordInput, confirmPasswordInput].forEach(input => {
      input.addEventListener('keydown', e => {
        if (e.key === ' ') e.preventDefault();
      });
    });

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const isFormValid = validateAllFields();
      if (!isFormValid) {
        showFormError('Por favor complete todos los campos correctamente');
        return;
      }

      Swal.fire({
        title: 'Actualizando contrase√±a...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const password = passwordInput.value;
        const response = await fetch('/Login/recuperar_correo/actualizar_contrase√±a.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `password=${encodeURIComponent(password)}`
        });

        const data = await response.json();
        Swal.close();

        if (data.success) {
          Swal.fire('‚úÖ', data.message, 'success').then(() => {
            window.location.href = "/Login/login.html";
          });
        } else {
          showFormError(data.message || 'Error al actualizar la contrase√±a');
        }
      } catch (error) {
        Swal.close();
        showFormError('Error de conexi√≥n con el servidor');
      }
    });
  });
</script>
